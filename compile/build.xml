<!DOCTYPE project>

<project name="proactive_grid_cloud_portal" default="compile" basedir=".">

	<property name="project-name" value="ProActive Grid Cloud Portal" />

    <property file="${user.home}/.proactive/build.properties" />
	<property file="${basedir}/build.properties" />

	<!-- to generate a release uncomment the variable rest_api.version -->
	<!-- in the build.properties file, then launch the generation of the war file -->

	<tstamp>
		<format property="rest_api.version" pattern="yyyyMMddHHmm" locale="en,UK" />
	</tstamp>

    <property name="doc.footer" value="Copyright 1997-2013 ActiveEon/INRIA/University of Nice-Sophia Antipolis" />
    <property name="doc.header" value="&lt;table style=&quot;color:#555555;font-size: 9pt;&quot;&gt; &lt;tr&gt; &lt;td&gt; &lt;img src= &quot;{@docRoot}/../../images/logo-ProActive_small.png&quot;&gt; &lt;/td&gt; &lt;td width= &quot;500&quot;&gt; &lt;h5&gt;An Open Source Solution for Enterprise Grids &amp; Clouds&lt;/h5&gt; &lt;h2&gt;ProActive Scheduling &amp; Resourcing &lt;/h2&gt; &lt;h2&gt;Rest Interface - version ${rest_api.version}&lt;/h4&gt; &lt;h4 class=&quot;author&quot; &gt;&lt;span class=&quot;surname&quot;&gt;Copyright 1997-2013 ActiveEon/INRIA/University of Nice-Sophia Antipolis&lt;/span&gt;&lt;/h4&gt; &lt;/td&gt;  &lt;td&gt;  &lt;a href= &quot;http://www.activeeon.com/&quot;&gt;&lt;img border=&quot;0&quot; src= &quot;{@docRoot}/../../images/logo-ActiveEon.png&quot; alt=&quot;ActiveEon&quot; title=&quot;ActiveEon: a Professional Open Source company, co-developing and providing support for ProActive Parallel Suite&quot;&gt;&lt;/a&gt;  &lt;a href= &quot;http://www.ow2.org/&quot;&gt;&lt;img border=&quot;0&quot; src= &quot;{@docRoot}/../../images/logo-OW2_small.png&quot; alt=&quot;OW2&quot; title=&quot;OW2 Consortium&quot; &gt;&lt;/a&gt; &lt;br&gt;  &lt;a href=&quot;http://www.inria.fr&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;{@docRoot}/../../images/logo-INRIA_small.png&quot; alt=&quot;INRIA&quot; title=&quot;A CNRS-INRIA-UNSA Research team&quot;&gt;&lt;/a&gt;  &lt;a href= &quot;http://www.unice.fr&quot;&gt;&lt;img border=&quot;0&quot; src= &quot;{@docRoot}/../../images/logo-UNSA_small.png&quot; alt=&quot;UNSA&quot; title=&quot;A CNRS-INRIA-UNSA Research team&quot;&gt;&lt;/a&gt;  &lt;a href=&quot;http://www.cnrs.fr&quot; &gt;&lt;img border=&quot;0&quot; src=&quot;{@docRoot}/../../images/logo-CNRS_small.png&quot; alt= &quot;CNRS-I3S&quot; title=&quot;A CNRS-INRIA-UNSA Research team&quot;&gt;&lt;/a&gt; &lt;/td&gt;  &lt;/tr&gt; &lt;/table&gt;" />

    <property name="projectRoot" value="${basedir}/.." />
    <property name="build.dir" value="${projectRoot}/build" />
    <property name="dist.dir" value="${projectRoot}/dist" />
	<property name="classes.dir" value="${build.dir}/classes" />
	<property name="classes.tests.dir" value="${build.dir}/test-classes" />
	<property name="lib.dir" value="${projectRoot}/lib" />
	<property name="war.root" value="${projectRoot}/WebContent" />
	<property name="webinf" value="${war.root}/WEB-INF" />
	<property name="webinf.lib.dir" value="${war.root}/WEB-INF/lib" />
	<property name="webinf.classes.dir" value="${war.root}/WEB-INF/classes" />
	<property name="webinf.lib.doc" value="${war.root}/WEB-INF/doc" />
	<property name="src.dir" value="${projectRoot}/src" />
    <property name="src.tests.dir"    value="${projectRoot}/tests" />
    <property name="junit.dir"    value="${projectRoot}/junitReports" />
    <property name="junit.grant.all.policy" value="${src.tests.dir}/functionaltests/config/client-java.security.policy" />

	<path id="test.classpath">
		<pathelement location="${classes.dir}"/>
		<pathelement location="${classes.tests.dir}"/>
		<path refid="src.classpath"/>
		<fileset dir="${lib.dir}/test">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<!-- 
		 Compile all
	-->

    <target name="copy.dependencies" description="Copy dependencies from the compiled Scheduling project">
        <copy todir="${lib.dir}/scheduling">
            <fileset dir="${scheduling.project.dir}/dist/lib" includes="*/**" >
				<exclude name="netty*.jar"/>
			</fileset>
        </copy>
    </target>

    <target name="prepare" description="Create dir for class files">
		<mkdir dir="${classes.dir}" />
        <mkdir dir="${classes.tests.dir}" />
        <mkdir dir="${dist.dir}" />
        <mkdir dir="${webinf.lib.dir}" />
        <mkdir dir="${war.root}/doc" />
		<copy todir="${webinf.classes.dir}">
			<fileset dir="${webinf}">
				<include name="log4j.properties" />
			</fileset>
		</copy>
	</target>

	<target name="clean" description="Delete class files">
		<delete dir="${classes.dir}" />
        <delete dir="${classes.tests.dir}" />
        <delete dir="${webinf.classes.dir}" />
        <delete dir="${webinf.lib.dir}" />
        <delete dir="${war.root}/doc" />
        <delete dir="${war.root}/images" />
        <delete dir="${war.root}/index.html" />
        <delete dir="${build.dir}" />
        <delete dir="${dist.dir}" />
        <delete dir="${junit.dir}" />
        <delete dir="${projectRoot}/tmp" />
		<delete>
		  <fileset dir="." includes="SchedulingRest-*.war" />
		</delete>
	</target>

	<path id="src.classpath">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
		</fileset>
		<pathelement location="${classes.dir}" />
		<fileset dir="${ant.library.dir}">
			<include name="**/*.jar" />
	 	</fileset>
	</path>

	<!-- NB: all the source files are the project source files -->

	<target name="compile" depends="prepare" description="Compiles the Java source code">
		<echo message="Compiling src files" />
		<javac srcdir="${src.dir}" destdir="${classes.dir}" deprecation="false" failonerror="true" debug="true">
			<classpath refid="src.classpath" />
		</javac>
	
		<taskdef name="stubGenerator" classname="ant.AntStubGenerator" classpathref="src.classpath" />
		<typedef name="class" classname="ant.AntStubGeneratorClass" classpathref="src.classpath" />
		
		<stubGenerator srcDir="${classes.dir}" refclasspath="src.classpath">
		    <class name="org.ow2.proactive_grid_cloud_portal.scheduler.MySchedulerProxyUserInterface" />
            <class name="org.ow2.proactive_grid_cloud_portal.scheduler.EventListener" />
		</stubGenerator>
		
	</target>

	<target name="compile.tests" depends="compile">
		<javac srcdir="${src.tests.dir}" destdir="${classes.tests.dir}" deprecation="false" failonerror="true" debug="true">
			<classpath refid="test.classpath" />
		</javac>
		<copy todir="${classes.tests.dir}" overwrite="true">
			<fileset dir="${src.tests.dir}" excludes="**/*.java" />
		</copy>
	</target>


	<target name="war" depends="compile,doc,schedulingrest-common-jar,schedulingrest-scheduler-jar,schedulingrest-rm-jar" description="Generate the war file">
		<!-- copy classes -->
		<!--
		<copy todir="WebContent/WEB-INF/classes">
			<fileset dir="build/classes">
				<include name="**" />
			</fileset>
		</copy>
	    -->
		<!-- copy jars -->
		<copy todir="${webinf.lib.dir}" flatten="true">
			<fileset dir="${lib.dir}/scheduling">
				<include name="**/*.jar" />
			</fileset>
			<fileset dir="${lib.dir}/resteasy">
				<include name="**/*.jar" />
			</fileset>
			<fileset dir="${lib.dir}/misc">
				<include name="**/*.jar" />
			</fileset>
		</copy>

		<war destfile="${dist.dir}/SchedulingRest-${rest_api.version}.war" webxml="${webinf}/web.xml" basedir="${war.root}">
			<manifest>
				<!-- Who is building this jar? -->
				<attribute name="Built-By" value="${user.name}" />
				<!-- Information about the program itself -->
				<attribute name="Implementation-Vendor" value="ActiveEon" />
				<attribute name="Implementation-Title" value="Scheduling Rest Api" />
				<!-- -->
				<attribute name="Implementation-Version" value="${rest_api.version}" />
				<attribute name="Specification-Version" value="${scheduler.version}" />
			</manifest>
		</war>
	</target>

	<target name="doc" depends="doc-jaxrs">
		<copy todir="${build.dir}">
			<fileset dir="${projectRoot}/doc/">
				<include name="**/*" />
			</fileset>
		</copy>
		<!-- copy doc content to war folder -->
		<copy todir="${war.root}/doc/jaxrsdocs">
			<fileset dir="${build.dir}/doc/jaxrsdocs/">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${war.root}/doc/jaxbdocs">
			<fileset dir="${build.dir}/doc/jaxbdocs/">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${war.root}" filtering="true">
			<filterset>
				<filter token="rest_api.version" value="${rest_api.version}" />
			</filterset>
			<fileset dir="${projectRoot}/doc">
				<include name="**/*" />
			</fileset>
		</copy>
	</target>

	<target name="doc-jaxrs" depends="doc-jaxb" description="Generate JAX-RS documentation">
		<javadoc useexternalfile="true"
				 classpathref="src.classpath" sourcepath="${src.dir}"
				 destdir="${build.dir}/doc/jaxrsdocs/" extdirs="${lib.dir}"
				 doclet="com.lunatech.doclets.jax.jaxrs.JAXRSDoclet" docletpathref="src.classpath"
				 footer="${doc.footer}" header="${doc.header}">
			<package name="org.ow2.proactive_grid_cloud_portal.*" />
			<link href="../jaxbdocs/" />
		</javadoc>
	</target>

	<target name="doc-jaxb" description="Generate JAXB documentation">
		<javadoc useexternalfile="true"
				 classpathref="src.classpath" sourcepath="${src.dir}"
				 destdir="${build.dir}/doc/jaxbdocs/" extdirs="${lib.dir}"
				 doclet="com.lunatech.doclets.jax.jaxb.JAXBDoclet" docletpathref="src.classpath"
				 footer="${doc.footer}" header="${doc.header}">
		<package name="org.ow2.proactive_grid_cloud_portal.*" />
		</javadoc>
	</target>

	<target name="schedulingrest-common-jar" depends="compile" description="create the jar containing the common files of scheduling rest">
		<jar jarfile="${webinf.lib.dir}/schedulingrest-common-${rest_api.version}.jar">
			<fileset dir="${classes.dir}">
				<include name="org/ow2/proactive_grid_cloud_portal/common/**" />
			</fileset>
			<fileset dir="${classes.dir}">
				<include name="org/ow2/proactive_grid_cloud_portal/webapp/**" />
			</fileset>
			<fileset dir="${classes.dir}">
				<include name="org/ow2/proactive_grid_cloud_portal/test/**" />
			</fileset>
			<manifest>
				<!-- Who is building this jar? -->
				<attribute name="Built-By" value="${user.name}" />
				<!-- Information about the program itself -->
				<attribute name="Implementation-Vendor" value="ActiveEon" />
				<attribute name="Implementation-Title" value="Scheduling Rest Common" />
				<!-- -->
				<attribute name="Implementation-Version" value="${rest_api.version}" />
				<attribute name="Specification-Version" value="${scheduler.version}" />
			</manifest>
		</jar>
	</target>

	<target name="schedulingrest-rm-jar" depends="compile" description="create the jar containing the rm files of scheduling rest">
		<jar jarfile="${webinf.lib.dir}/schedulingrest-rm-${rest_api.version}.jar">
			<fileset dir="${classes.dir}">
				<include name="org/ow2/proactive_grid_cloud_portal/rm/**" />
			</fileset>


			<manifest>
				<!-- Who is building this jar? -->
				<attribute name="Built-By" value="${user.name}" />
				<!-- Information about the program itself -->
				<attribute name="Implementation-Vendor" value="ActiveEon" />
				<attribute name="Implementation-Title" value="Scheduling Rest Resource Manager" />
				<!-- -->
				<attribute name="Implementation-Version" value="${rest_api.version}" />
				<attribute name="Specification-Version" value="${scheduler.version}" />

			</manifest>
		</jar>
	</target>

	<target name="schedulingrest-scheduler-jar" depends="compile" description="create the jar containing the scheduler files of scheduling rest">
		<jar jarfile="${webinf.lib.dir}/schedulingrest-scheduler-${rest_api.version}.jar">
			<fileset dir="${classes.dir}">
				<include name="org/ow2/proactive_grid_cloud_portal/scheduler/**" />
				<include name="org/ow2/proactive_grid_cloud_portal/novnc/**" />
				<include name="pa/stub/org/ow2/proactive_grid_cloud_portal/scheduler/**" />
			</fileset>
			<manifest>
				<!-- Who is building this jar? -->
				<attribute name="Built-By" value="${user.name}" />
				<!-- Information about the program itself -->
				<attribute name="Implementation-Vendor" value="ActiveEon" />
				<attribute name="Implementation-Title" value="Scheduling Rest Scheduler" />
				<!-- -->
				<attribute name="Implementation-Version" value="${rest_api.version}" />
				<attribute name="Specification-Version" value="${scheduler.version}" />
			</manifest>
		</jar>
	</target>

	<macrodef name="junitMacro">
		<attribute name="testdir"/>
		<sequential>
			<fail unless="restapi.test.rm.home" message="restapi.test.rm.home property not defined" />
			<fail unless="restapi.test.scheduler.home" message="restapi.test.scheduler.home property not defined" />
			<delete dir="${junit.dir}"/>
			<mkdir dir="${junit.dir}"/>
			<junit printsummary="yes" showoutput="false" timeout="300000" haltonfailure="true">
				<jvmarg value="-Djava.security.manager"/>
				<jvmarg value="-Djava.security.policy=${junit.grant.all.policy}"/>					
				<jvmarg value="-Drestapi.test.rm.home=${restapi.test.rm.home}"/>
				<jvmarg value="-Drestapi.test.scheduler.home=${restapi.test.scheduler.home}"/>
				<classpath>
					<path refid="test.classpath"/>
				</classpath>

				<formatter type="xml"/>

				<batchtest fork="yes" todir="${junit.dir}">
					<fileset dir="@{testdir}">
						<include name="org/ow2/proactive_grid_cloud_portal/**/*Test.java" />
						<include name="**/RestSchedulerJobTaskTest.java" />
						<include name="**/RestSchedulerTest.java" />
						<include name="**/RestfulSchedulerFreezeTest.java" />
                        <include name="**/RestSchedulerKillTest.java" />
						<include name="**/RestSchedulerJobPaginationTest.java" />
					</fileset>
				</batchtest>
			</junit>
		</sequential>
	</macrodef>

	<target name="junit" depends="compile.tests" description="Run rest tests">
		<junitMacro testdir="${src.tests.dir}"/>
	</target>

</project>
